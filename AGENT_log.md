# AGENT Log

Notes on agent work sessions. Each bullet can be upvoted/downvoted with (+1) or (-1) annotations appended over time.

- [2026-01-24] Created AGENT_log.md because it was missing; read AGENTS.md and CLAUDE.md for repo guidance; user only greeted, no task yet. (+1)
- [2026-01-24] Updated vault detail desktop layout: tabs selector now flush under header (removed spacer), tabs restyled to match inner-shadow selector buttons, VaultOverview metrics card loses bottom rounding via new MetricsCard className prop, and widget column top padding removed to align with user metrics. No tests run. (+1)
- [2026-01-24] Adjusted vault detail sticky offsets by measuring the header height with ResizeObserver and using it for the sticky top calculation, so the section selector/widget stop flush under the compressed header. No tests run. (+1)
- [2026-01-24] Made section scroll offsets dynamic: compute header height var, measure vault header + section selector heights via ResizeObserver, feed into scroll spy/scroll margin/scroll-to logic so active tab changes line up with sticky stack. No tests run. (+1)
- [2026-01-24] User requested to keep the APY disclaimer positioning change as-is (no revert). (+1)
- [2026-01-24] Updated vault compare modal (scroll lock on open, column hover reveals remove X, header links open new tab with link-out icon, left-aligned values, strategies sorted by allocation, removed clear-selection button). Added `IconGitCompare` and used it on the Compare button. Adjusted filters button to show blue outline + text when active. Removed holdings chip on desktop (mobile only). Implemented new formatting helpers in `src/components/shared/utils/format.ts`: `formatApyDisplay`, `formatTvlDisplay`, `normalizeApyDisplayValue`; applied across APY/TVL/holdings/compare/tooltips. Important: APY values are stored as fractions (e.g., 0.40 for 40%); `formatApyDisplay` now multiplies by 100 so output matches expected percent, and sorting uses `normalizeApyDisplayValue` so order matches display. TVL compact formatting enforces 3 significant digits (e.g., `$7.00M`). Lint/build ran clean (build emits existing rollup warnings about /*#__PURE__*/ in deps and chunk size). (+1)
- [2026-01-24] Read AGENTS.md and AGENT_log.md per repo instructions; user greeted with "hello" and provided no task yet. (+1)
- [2026-01-24] Updated tooltip positioning to default above: `Tooltip` component default side now `top`, APY tooltip config uses `side: 'top'`, CSS `.tooltiptext` now anchors above with arrow flipped, added `.tooltip.bottom` override for below, and VaultRiskScoreTag tooltip classes switched to `bottom-full mb-1`. Tests not run. (+1)
- [2026-01-24] Moved vault header metric footnotes (TVL + user holdings) into tooltips by adding a `footnoteDisplay` option on `MetricsCard` and enabling it in `VaultDetailsHeader`. Avoided adding underline/cursor changes. (+1)

## Gotchas

- APY values are stored as fractions (0.40 == 40%); use `formatApyDisplay` (multiplies by 100) and `normalizeApyDisplayValue` for sort/display parity.
- TVL/holdings display uses `formatTvlDisplay` with 3 significant digits for compact notation (e.g., `$7.00M`), and 3–4 digits for sub-10k amounts.
- The app’s global CSS forces `html { overflow: auto !important; }`; modal scroll locks need to set `document.documentElement` overflow with `!important` if you want to fully block background scroll.
- [2026-01-24] Moved the renderable section selector into VaultDetailsHeader (below vault metrics), passing tabs/active key/select handler and selector ref from the page; removed the old selector block from the details grid. Not yet re-run lint/build. (+1)
- [2026-01-24] Moved section selector into the same grid cell as VaultOverviewCard to remove the row gap; selector now stacked directly under metrics with zero vertical gap. Not yet re-run lint/build. (+1)
- [2026-01-24] Restored selector to its own grid row for compressed header while removing the expanded-view gap via conditional negative margin on the selector row. Not yet re-run lint/build. (+1)
- [2026-01-24] Removed row gap in VaultDetailsHeader grid by switching gap-6 to gap-0. Not yet re-run lint/build. (+1)
- [2026-01-24] Switched VaultDetailsHeader grid gap to `gap-y-0 gap-x-6` to keep column spacing while removing row gaps. Not yet re-run lint/build. (+1)
- [2026-01-24] Extracted the section selector buttons into a `SectionSelectorBar` function and used it in VaultDetailsHeader. Not yet re-run lint/build. (+1)
- [2026-01-24] Fixed selector bar stacking by moving the grid column span to the wrapper row and ensuring SectionSelectorBar is full width, so buttons lay out horizontally. Not yet re-run lint/build. (+1)
- [2026-01-24] Investigated isCompressed behavior in MetricsCard; noted it only toggles border class and may be visually subtle, and header compression depends on dev flag (collapsible mode). No code changes in this step. (+1)
- [2026-01-24] Lifted widget tab state to the vault detail page, added WidgetTabs export + controlled mode support, and rendered tabs under UserHoldingsCard in the header while hiding tabs inside the widget body. Not yet re-run lint/build. (+1)
- [2026-01-24] Lint/build: removed unused `nextSticky` and reordered imports; MetricsCard `isCompressed` made optional to fix portfolio usage; build succeeded with existing Rollup PURE comment warnings and chunk size warning. (+1)
- [2026-01-24] Disabled scroll-spy updates during programmatic scroll-to (tracks target and re-enables after reach/timeout) and stabilized section selector button borders with transparent base border + removed focus ring to stop flicker. Not yet re-run lint/build. (+1)
- [2026-01-24] Fixed active tab border visibility by forcing `!border-border` to override base `border-transparent` in section selector buttons. Not yet re-run lint/build. (+1)
- [2026-01-24] Applied the same border-stabilizing pattern to widget tabs (base transparent border + !border-border when active) to prevent flicker. Not yet re-run lint/build. (+1)
- [2026-01-24] Adjusted scroll offset to use compressed header height when starting uncompressed, and disabled Performance tab clicks until header is compressed (aria-disabled + guard). Not yet re-run lint/build. (+1)
- [2026-01-24] Adjusted section scroll offset to avoid double-counting selector height when header is compressed (use compressed header height + selector only when uncompressed). Not yet re-run lint/build. (+1)
- [2026-01-24] Added pending scroll flow: when header is uncompressed, clicking a section first auto-scrolls to trigger compression, then scrolls to the target once compression is detected, keeping scroll-spy disabled during the programmatic scroll. Not yet re-run lint/build. (+1)
- [2026-01-24] Lint/build run again; cleaned unused variables in VaultDetailsHeader (availableToDeposit/availableAmount); build succeeded with existing Rollup PURE comment warnings and chunk size warning. (+1)
- [2026-01-24] Simplified vault detail scroll offset: derive section scroll offset from live header height + global header via updateSectionScrollOffset (ResizeObserver + resize), removed compressed height constant/snapshot, and wired VaultDetailsHeader to report isCompressed to the page for pending scroll logic; scroll-to now uses fresh offset measurement. Lint/build run (biome check, tsc+vite) with existing Rollup PURE comment warnings and chunk size warning. (+1)
- [2026-01-24] Adjusted vault section scroll-to targets to stop 16px earlier (scroll padding) so clicks land just before the section start; applied to both pending-scroll and direct scroll handlers. No tests run. (+1)
- [2026-01-24] Shifted scroll-spy activation 16px earlier by adding scrollPadding to offsetTop and reusing the same padding for scroll-to targets, so active selector state aligns with the new stop position. No tests run. (+1)
- [2026-01-24] Refactored VaultDetailsHeader: extracted VaultHeaderIdentity component for logo/title/chips, and wrapped the compressed header identity + VaultOverviewCard + SectionSelectorBar in a bordered container (col-span-13) while keeping uncompressed layout unchanged. No tests run. (+1)
- [2026-01-24] Ran lint/build after refactor; removed unused headerIdentity var in VaultDetailsHeader. Lint clean; build succeeded with existing Rollup PURE comment warnings + chunk size warning. (+1)
- [2026-01-24] Tightened widget tabs placement in compressed header by removing top border/rounding and overlapping by 1px (className on WidgetTabs) so they sit flush under UserHoldingsCard. No tests run. (+1)
- [2026-01-24] Re-grouped uncompressed header layout so VaultOverviewCard and SectionSelectorBar share the same column stack (no separate grid row), keeping them tight while preserving the compressed container layout. No tests run. (+1)
- [2026-01-24] Added a 400px minimum height to the vault detail widget column wrapper (min-h-[400px]) in the desktop layout. No tests run. (+1)
- [2026-01-24] Made widget container fill available height by turning the inner wrapper into flex-1 column and making the content area flex-1, so it stretches when the parent has a min-height. No tests run. (+1)
- [2026-01-24] Made widget column a flex container and ensured Widget/SelectedComponent stretch: Widget root now flex-1; content wrapper applies flex-1 + h-full to the immediate child via [&>div] so the bordered widget fills the min-height space. No tests run. (+1)
- [2026-01-24] Reworked widget action layouts (deposit/withdraw/migrate) to keep inputs at the top and push details + action buttons to the bottom via flex + mt-auto; added h-full/flex-1 wrappers to make the spacing work. No tests run. (+1)
- [2026-01-24] Fixed lint by removing unused expectedShares prop from VaultSharesOverlay; lint/build succeeded (existing Rollup PURE comment + chunk size warnings). (+1)
- [2026-01-24] Moved widget settings into a new SettingsOverlay (InfoOverlay-based) triggered by a gear button in WidgetTabs; added settings open state wiring between VaultDetailsHeader and Widget; removed SettingsPopover from deposit/withdraw and cleaned unused context setters. Deleted SettingsPopover file. No tests run. (+1)
- [2026-01-24] Added widget settings overlay (InfoOverlay) with unique IDs, wired gear button in WidgetTabs (header + widget) to toggle settings state from the vault page, removed SettingsPopover usage and cleaned imports. Lint clean after fixes. No build run. (+1)
- [2026-01-24] Widget tabs now close the settings overlay when clicking the currently active action (uses isSettingsOpen + onOpenSettings toggle). No tests run. (+1)
- [2026-01-24] Widget action tabs now always close settings overlay when any action tab is clicked (if open), not just the active one. No tests run. (+1)
- [2026-01-24] Added wallet overlay in widget: new WalletOverlay (balances + recent transactions), wallet button in WidgetTabs next to settings, shared state wired through vault page/header/widget; action tab clicks close overlays and settings/wallet toggles are mutually exclusive. Lint clean. No build run. (+1)
- [2026-01-24] Added disableMotion support to InfoOverlay and disabled transitions for SettingsOverlay and WalletOverlay. No tests run. (+1)
- [2026-01-24] Updated widget column height constraints to use viewport-based min/max height (calc(100vh-233px)) instead of fixed 400px, so it fills the screen without exceeding it. No tests run. (+1)
- [2026-01-25] Removed the widget column min-height, leaving only a viewport-based max-height so the widget grows with content but won't exceed the screen. No tests run. (+1)
- [2026-01-25] Refactored widget settings/wallet into separate panels (SettingsPanel/WalletPanel) rendered alongside the widget in the sticky column; widget stays mounted but hidden so deposit state persists when toggling; settings now commit on close/deactivate to preserve values. No tests run. (+1)
- [2026-01-25] Lint/build run after widget panel refactor; lint clean. Build succeeded with existing Rollup /*#__PURE__*/ comment warnings from deps and chunk size warning. (+1)
- [2026-01-25] Wallet panel now filters transactions to the current vault, lists zap-ready wallet tokens on the vault chain, bolds deposited amounts, and removes the close X (settings/wallet panels are true widgets). Lint/build run as requested at end of turn; build still shows existing Rollup /*#__PURE__*/ warnings and chunk size warning. (+1)
- [2026-01-25] Wallet panel share rows now only show total shares when both deposited and staked balances exist; otherwise shows the single relevant share row. Lint/build run; build still shows existing Rollup /*#__PURE__*/ warnings and chunk size warning. (+1)
- [2026-01-25] Added an “All activity” button next to Recent transactions in the wallet panel to open the notifications curtain. Lint/build run; build still shows existing Rollup /*#__PURE__*/ warnings and chunk size warning. (+1)
- [2026-01-25] Wallet panel now shows USD amounts in parentheses for shares, wallet balance, and zap-ready tokens, switches amount formatting to “value symbol,” filters/labels transaction amount order, and lets zap tokens prefill the deposit widget (with hover overlay text). Lint/build run; build still shows existing Rollup /*#__PURE__*/ warnings and chunk size warning. (+1)
- [2026-01-25] Zap token click now only switches the deposit asset without autofilling amount; prefill amount made optional and deposit keeps existing input. Lint/build run; build still shows existing Rollup /*#__PURE__*/ warnings and chunk size warning. (+1)
- [2026-01-25] Share amount labels now fall back to “vault shares” when the share token symbol/name is longer than that label, reducing overflow on long symbols. Lint/build run; build still shows existing Rollup /*#__PURE__*/ warnings and chunk size warning. (+1)
- [2026-01-25] Verified long share labels use “vault shares” fallback in `WalletPanel`; ran `bun run lint` and `bun run build` (build still shows existing Rollup /*#__PURE__*/ warnings and chunk size warning). (+1)
- [2026-01-25] Identified widget max-height location in `src/components/pages/vaults/[chainID]/[address].tsx` (sticky widget column uses `max-h-[calc(100vh-233px)]` and `top: 233px`); ran lint/build (same Rollup /*#__PURE__*/ + chunk size warnings). (+1)
- [2026-01-25] Set dynamic `--vault-header-height` from the measured header stack and used it for the widget column `top` and `max-h` so the widget always fits beneath the vault header as it resizes; ran lint/build (same Rollup /*#__PURE__*/ + chunk size warnings). (+1)
- [2026-01-25] Updated vault header height calc to use header `getBoundingClientRect().bottom` and refresh on compression state changes, keeping widget max-height in sync when header expands/collapses; ran lint/build (same Rollup /*#__PURE__*/ + chunk size warnings). (+1)
- [2026-01-25] Added static `--vault-header-max-offset` captured only from the uncompressed header to cap widget max-height while keeping dynamic header offset for scroll/top alignment; ran lint/build (same Rollup /*#__PURE__*/ + chunk size warnings). (+1)
- [2026-01-25] Simplified widget max-height to use a single `--vault-header-initial-offset` captured only on initial uncompressed load; compressed state no longer affects max height; ran lint/build (same Rollup /*#__PURE__*/ + chunk size warnings). (+1)
- [2026-01-25] Corrected initial header offset measurement to explicitly sum site header height + VaultDetailsHeader height for widget max-height; ran lint/build (same Rollup /*#__PURE__*/ + chunk size warnings). (+1)
- [2026-01-25] Added debug logging for vault header offset calculations (base header, VaultDetailsHeader height, computed offsets) to help diagnose widget max-height issues; ran lint/build (same Rollup /*#__PURE__*/ + chunk size warnings). (+1)
- [2026-01-25] Adjusted initial offset capture to require nonzero VaultDetailsHeader height (and uncompressed) before setting `--vault-header-initial-offset`, preventing early 68px-only capture; ran lint/build (same Rollup /*#__PURE__*/ + chunk size warnings). (+1)
- [2026-01-25] Added 16px padding to the captured initial header offset used for widget max-height, reducing widget height slightly for bottom breathing room; ran lint/build (same Rollup /*#__PURE__*/ + chunk size warnings). (+1)
- [2026-01-25] Simplified widget max-height logic: initial offset captured once on uncompressed load (no ongoing compressed recompute), removed debug logs, kept dynamic header offset only for scroll alignment; ran lint/build (same Rollup /*#__PURE__*/ + chunk size warnings). (+1)
